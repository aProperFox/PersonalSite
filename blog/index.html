<!DOCTYPE html>
<html>
<head>
	<title>Fun times in Ecuador</title>
	<link rel="stylesheet" href="css/style.css">
	<link rel="icon" href="pictures/icon.png">
	<link href='http://fonts.googleapis.com/css?family=Antic|Oxygen' rel='stylesheet' type='text/css'>
	<script type="text/javascript"> 
		var ua=navigator.userAgent; 
		if (ua.indexOf("Mobile")!=-1) window.location = "/mobile.html"; 
		if (ua.indexOf("iPad")!=-1) window.location = "/mobile.html";
		if (ua.indexOf("iPhone")!=-1) window.location = "/mobile.html";
	</script> 
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="js/preloadjs-0.6.0.min.js"></script>
	<script src="js/tinysort.min.js"></script>
</head>
<body>

	<div class="title-bar">
		<h1 id="header">Mis Aventuras en el Ecuador</h1>
	</div>

	<div id="navbar_wrapper">
		<div id="navbar">
			<ul>
				<li><a id="0" href="../?WELCOME" data-information="welcome">WELCOME</a></li> 
				<li><a id="1" href="javascript:void(0)" data-information="blog">BLOG</a></li> 
				<li><a id="2" href="../?EDUCATION" data-information="education">EDUCATION</a></li> 
				<li><a id="3" href="../?PROJECTS" data-information="projects">PROJECTS</a></li> 
				<li><a id="4" href="../?OCCUPATION" data-information="occupation">OCCUPATION</a></li> 
				<li><a id="5" href="../?CONTACT" data-information="contact">CONTACT</a></li> 
			</ul>   
		</div>
	</div>

	<div class="overlay" id="modalOverlay"></div>
	<div class="modal">
		<h1 class="close-button" id="post-close"><b>X</b></h1>
		<div id="post-image">
			<img>
		</div>
		<div class="post-text">
			<h2 id="post-title"></h2>
			<h4 id="post-date"></h4>
			<p id="postContent"></p>
		</div>
	</div>
	<div class="overlay" id="pictureOverlay"></div>
	<div id="pictureViewer">
		<h1 class="close-button" id="imageViewerClose"><b>X</b></h1>
		<div id="leftPictureArea"></div>
		<div id="rightPictureArea"></div>
		<div id="imageCaption">
			<p>
				This is a caption. Imagine that!
			</p>
		</div>
	</div>
	<div class="content">
	</div>

	<div class="footer-bar">
		<h1 class="center"></h1>
	</div>

	<script type="text/javascript">
		var posts = [];	
		var postHTMLs = [];
		var imageHash = new Object();
		var currentPostId = '';
		var currentImageArray = [];
		var isFirstImage = true;
		var loadedPosts = [];
		var loadedPicturesHash = new Object();
		var loadingPostIds = [];

		// Load JSON data
		$(document).ready(function() {
			var intro = '<div class="post" id="',
					second = '">\n<figure>\n<img src="',
					middle = '"></img>\n<figcaption class="unselectable">',
					end = '</figcaption>\n</figure>\n</div>';
			$.getJSON("getposts", function(data) {
				$.each( data, function(key, val) {
					posts.push(val);
					var divID = val.date;
					$.getJSON("getimages/" + val.id, function(images) {
						var friendlyImage = ('pictures/' + val.id + '/' + images[0].name);
						postHTMLs.push($.parseHTML(intro + divID + second + friendlyImage + middle + val.title + end));
						var imagesString = [];
						images.forEach(function(element, index, arr) {
							imagesString.push(element.name);
						});
						imageHash[val.id] = imagesString;
					}).done(function(data) {
    				postHTMLs.forEach(function(element, index, arr) {
							$(element).appendTo(".content");
						});
						tinysort('.content > div',{attr: 'id'});
					});
					loadedPicturesHash[val.id] = [];
				});
			});

			$this = $("a:contains(BLOG)");
			$this.parent().addClass("current-post").hover(function() {
				$(this).css("background-color", "#3b3b3b");
			}, function() {
				$(this).css("background", "transparent");
			});
     	$this.css({"color": "#ABBF87"});
		});

		// Toggle the post modal visibility
		function toggleModal() {
			$('.modal').fadeToggle(300); 
			$('#modalOverlay').fadeToggle(300);
		};	
		
		// Display the modal when clicking a post. Load the data from database.
		$(document).on('click', '.post', function() {
			var scrollTop = $(document).scrollTop() + 20;
			var imageSource = $(this).find('img').attr('src');
			$('.modal').find('img').attr('src', imageSource);
			$('.modal').css("top", scrollTop + "px");
			$('#post-title').text($(this).find('figcaption').text());
			var postText, postDate;
			var BreakException= {};
			try {
				posts.forEach(function(element, index, arr) {
					if(element.id.indexOf(imageSource.substring(9,33)) != -1) {
						$('#postContent').empty().append($.parseHTML(element.text));
						$('#post-date').text(element.friendlyDate);
						currentPostId = element.id;
						currentImageArray = imageHash[element.id];
						throw BreakException;
					}
				});
			} catch(e) {
    		if (e!==BreakException) throw e;
			}
			toggleModal();
			isFirstImage = true;
			if($.inArray(currentPostId, loadedPosts) == -1) {
				loadingPostIds.push(currentPostId);
				loadImages(currentPostId);
				loadedPosts.push(currentPostId);
			}
		});

		// Close the modal when clicking outside its bounds
		$('#modalOverlay').click(function() {
			toggleModal();
		});
		
		// Close the modal when clicking the 'X'
		$('#post-close').click(function() {
			toggleModal();
		});

		// Toggle image viewer visibility
		function togglePictureViewer() {
			$('#pictureOverlay').fadeToggle(300);
      $('#pictureViewer').fadeToggle(300);
		};

		// Hide image viewer
		$('#pictureOverlay').click( function() {
			togglePictureViewer();
		});	

		// Display image viewer
		$('#post-image img').click(function() {
			$('#fullScreenPicture').attr('src', $(this).attr('src'));
			togglePictureViewer();
		});

		// Close the image viewer
		$('#imageViewerClose').click(function() {
			togglePictureViewer();
		});

		// Change image
		function switchImage(isPositive) {
			var $fspic = $('img.currentImage');
			if(isPositive) {
				if($fspic.parent().children("img:last").attr('src') == $fspic.attr('src')) {
					$fspic.parent().children("img:first")
						.fadeIn()
						.addClass('currentImage');
				} else {
					$fspic.next()
						.fadeIn()
						.addClass('currentImage');
				}
				$fspic.fadeOut().removeClass("currentImage");
			} else {
				if($fspic.parent().children("img:first").attr('src') == $fspic.attr('src')) {
					$fspic.parent().children("img:last")
						.fadeIn(300)
						.addClass('currentImage');
				} else if(imageHash[currentPostId].length == 1) {
					$fspic.fadeIn();
				} else {
					$fspic.prev()
						.fadeIn()
						.addClass('currentImage');
				}
				$fspic.fadeOut().removeClass("currentImage");
			}
		}

		// Next image
		$('#rightPictureArea').click(function() {
			switchImage(true);
		});

		// Previous image
		$('#leftPictureArea').click(function() {
			switchImage(false);
		});

		$(document).keydown(function( event ) {
			if($('#pictureViewer').is(":visible")) {
				if(event.which == 37) {
					switchImage(false);
				} else if(event.which == 39) {
					switchImage(true);
				} else if(event.which == 27) {
					togglePictureViewer();
				}
			} else if($('.modal').is(":visible")) {
				if(event.which == 27) {
					toggleModal();
				}

			}
		});

		function loadImages(folder) {
			$('#pictureViewer').css("background-image", "url(pictures/loader.gif')");
  		var preload = new createjs.LoadQueue();
 	 		preload.addEventListener("fileload", handleFileComplete);
			for (var i = 0; i < currentImageArray.length; i++) {
				var imageString = "pictures/" + folder + "/" + currentImageArray[i];
	  		preload.loadFile({
					src:imageString
				});
			}
			preload.on("complete", handleComplete, this);
		}

		function handleFileComplete(event) {
			var item = event.result;
			var jitem = $(item);
			jitem.addClass("full-screen-picture");
			loadedPicturesHash[loadingPostIds[0]].push(jitem);
			if(isFirstImage) {
				jitem.addClass("currentImage");
				isFirstImage = false;
			} else {
				jitem.css('display', 'none');
			}
			jitem.prependTo('#pictureViewer');
			console.log("file " + jitem.attr('src')  + "  loaded");
		}

		function handleComplete(event) {
			$('#pictureViewer').css("background-image", "none");
			loadingPostIds.shift();
		}

		$(function() {
		 
			// grab the initial top offset of the navigation 
			var sticky_navigation_offset_top = $('#navbar').offset().top;
				 
			// our function that decides weather the navigation bar should have "fixed" css position or not.
			var sticky_navigation = function(){
				var scroll_top = $(window).scrollTop(); // our current vertical position from the top
						 
				// if we've scrolled more than the navigation, change its position to fixed to stick to top,
				// otherwise change it back to relative
				if (scroll_top > sticky_navigation_offset_top) { 
					$('#navbar').css({ 'position': 'fixed', 'top':0, 'left':0 });
				} else {
					$('#navbar').css({ 'position': 'relative', 'top': '10px' }); 
				}   
			};
				 
			// run our function on load
			sticky_navigation();
				 
			// and run it again every time you scroll
			$(window).scroll(function() {
				sticky_navigation();
			});
		 
		});

	</script>

</body>
</html>
