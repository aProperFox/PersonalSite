<!DOCTYPE html>
<html>
<head>
	<title>Fun times in Ecuador</title>
	<link rel="stylesheet" href="css/style.css">
	<link rel="icon" href="pictures/icon.png">
	<link href='http://fonts.googleapis.com/css?family=Poiret+One|Oxygen:400,300,700' rel='stylesheet' type='text/css'>
	<script type="text/javascript"> 
		var ua=navigator.userAgent; 
		if (ua.indexOf("Mobile")!=-1) window.location = "/mobile.html"; 
		if (ua.indexOf("iPad")!=-1) window.location = "/mobile.html";
		if (ua.indexOf("iPhone")!=-1) window.location = "/mobile.html";
	</script> 
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css" />
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
	<script src="js/preloadjs-0.6.0.min.js"></script>
</head>
<body>

	<div class="title-bar">
		<h1 class="center">MIS AVENTURAS EN EL ECUADOR</h1>
	</div>

	<div class="overlay" id="modalOverlay"></div>
	<div class="modal">
		<h1 class="close-button" id="post-close"><b>X</b></h1>
		<div id="post-image">
			<img src="#">
		</div>
		<div class="post-text">
			<h2 id="post-title"></h2>
			<h4 id="post-date"></h4>
			<p id="postContent"></p>
		</div>
	</div>
	<div class="overlay" id="pictureOverlay"></div>
	<div id="pictureViewer">
		<h1 class="close-button" id="imageViewerClose"><b>X</b></h1>
		<div id="leftPictureArea"></div>
		<div id="rightPictureArea"></div>
	</div>
	<div class="content round">
	</div>

	<script type="text/javascript">
		var posts = [];	
		var imageHash = new Object();
		var currentPostId = '';
		var currentImageArray = [];
		var isFirstImage = true;

		// Load JSON data
		$(document).ready(function() {
			var intro = '<div class="post">\n<figure>\n<img src="',
					middle = '"></img>\n<figcaption class="unselectable">',
					end = '</figcaption>\n</figure>\n</div>';
			$.getJSON("getposts", function(data) {
				$.each( data, function(key, val) {
					posts.push(val);
					$.getJSON("getimages/" + val.id, function(images) {
						var friendlyImage = ('pictures/' + val.id + '/' + images[0].name);
						$('.content').append($(intro + friendlyImage + middle + val.title + end));
						var imagesString = [];
						images.forEach(function(element, index, arr) {
							imagesString.push(element.name);
						});
						imageHash[val.id] = imagesString;
					});
				});
			});
		});

		// Toggle the post modal visibility
		function toggleModal() {
			$('.modal').fadeToggle(300); 
			$('#modalOverlay').fadeToggle(300);
		};	
		
		// Display the modal when clicking a post. Load the data from database.
		$(document).on('click', '.post', function() {
			var scrollTop = $(document).scrollTop() + 20;
			var imageSource = $(this).find('img').attr('src');
			$('.modal').find('img').attr('src', imageSource);
			$('.modal').css("top", scrollTop + "px");
			$('#post-title').text($(this).find('figcaption').text());
			var postText, postDate;
			var BreakException= {};
			try {
				posts.forEach(function(element, index, arr) {
					if(element.id.indexOf(imageSource.substring(9,33)) != -1) {
						$('#postContent').empty().append($.parseHTML(element.text));
						$('#post-date').text(element.date);
						currentPostId = element.id;
						currentImageArray = imageHash[element.id];
						throw BreakException;
					}
				});
			} catch(e) {
    		if (e!==BreakException) throw e;
			}
			toggleModal();
			isFirstImage = true;
			loadImages(currentPostId);
		});

		// Close the modal when clicking outside its bounds
		$('#modalOverlay').click(function() {
			toggleModal();
		});
		
		// Close the modal when clicking the 'X'
		$('#post-close').click(function() {
			toggleModal();
		});

		// Toggle image viewer visibility
		function togglePictureViewer() {
			$('#pictureOverlay').fadeToggle(300);
      $('#pictureViewer').fadeToggle(300);
		};

		// Hide image viewer
		$('#pictureOverlay').click( function() {
			togglePictureViewer();
		});	

		// Display image viewer
		$('#post-image img').click(function() {
			$('#fullScreenPicture').attr('src', $(this).attr('src'));
			togglePictureViewer();
		});

		// Close the image viewer
		$('#imageViewerClose').click(function() {
			togglePictureViewer();
		});

		// Change image
		function switchImage(isPositive) {
			var $fspic = $('img.currentImage');
			if(isPositive) {
				console.log("siblings: " + ($fspic.siblings(":last").attr('src')));
				$fspic.fadeOut(300);
				if($fspic.next().attr('class') == undefined) {
					$fspic.siblings().first()
						.fadeIn(300)
						.addClass('currentImage').end()
					.removeClass('currentImage');
				} else {
					$fspic.next()
						.fadeIn(300)
						.addClass('currentImage').end()
					.removeClass('currentImage');
				}
			} else {
				console.log("siblings: " + ($fspic.siblings(":last").attr('src')));
				$fspic.fadeOut(300)
				.prev()
					.fadeIn(300)
					.addClass('currentImage').end()
				.removeClass('currentImage');
			}
		}

		// Next image
		$('#rightPictureArea').click(function() {
			switchImage(true);
		});

		// Previous image
		$('#leftPictureArea').click(function() {
			switchImage(false);
		});

		$(document).keydown(function( event ) {
			if($('#pictureViewer').is(":visible")) {
				if(event.which == 37) {
					switchImage(false);
				} else if(event.which == 39) {
					switchImage(true);
				} else if(event.which == 27) {
					togglePictureViewer();
				}
			} else if($('.modal').is(":visible")) {
				if(event.which == 27) {
					toggleModal();
				}

			}
		});

		function loadImages(folder) {
  		var preload = new createjs.LoadQueue();
 	 		preload.addEventListener("fileload", handleFileComplete);
			for (var i = 0; i < currentImageArray.length; i++) {
				var imageString = "pictures/" + folder + "/" + currentImageArray[i];
	  		preload.loadFile({
					src:imageString
				});
			}
		}

		function handleFileComplete(event) {
			var item = event.result;
			var jitem = $(item);
			jitem.addClass("full-screen-picture").attr('alt', "pictures/loader.gif");
			if(isFirstImage) {
				jitem.addClass("currentImage");
				isFirstImage = false;
			} else {
				jitem.css('display', 'none');
			}
			jitem.prependTo('#pictureViewer');
			console.log("file " + jitem.attr('src')  + "  loaded");
		}

	</script>

</body>
</html>
